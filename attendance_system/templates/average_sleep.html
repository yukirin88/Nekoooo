{% extends "bootstrap/base.html" %}
{% block title %}平均睡眠時間{% endblock %}
{% block content %}
<div class="container">
    <h1>平均睡眠時間　<a href="{{ url_for('index') }}" class="btn btn-primary">ホームに戻る</a></h1>

    <!-- ドロップダウン -->
    <select class="form-control" id="periodSelect" onchange="changePeriod(this.value)">
        <option value="daily" {% if period == 'daily' %}selected{% endif %}>日別</option>
        <option value="weekly" {% if period == 'weekly' %}selected{% endif %}>週別</option>
        <option value="monthly" {% if period == 'monthly' %}selected{% endif %}>月別</option>
        <option value="all" {% if period == 'all' %}selected{% endif %}>全期間</option>
    </select>

    <!-- 日別表示 -->
    {% if period == 'daily' %}
        {% if sleep_times|length < 2 %}
            <div class="alert alert-warning mt-3">最低でも2日記録が必要です。</div>
        {% else %}
            <p>平均睡眠時間: {{ daily_avg.avg_hours }}時間{{ daily_avg.avg_minutes }}分</p>
            <h3 class="mt-4">日別睡眠記録</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>日付</th>
                        <th>睡眠時間</th>
                        <th>前日比</th>
                        <th>評価</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in sleep_times %}
                    <tr>
                        <td>{{ item.date }}</td>
                        <td>{{ item.hours }}時間{{ item.minutes }}分</td>
                        <td>
                            {% if loop.index0 == sleep_times|length - 1 %}
                                -
                            {% else %}
                                {% set next_item = sleep_times[loop.index0 + 1] %}
                                {% set diff = item.duration - next_item.duration %}
                                {% set diff_abs = diff|abs %}
                                {% set diff_hours = int(diff_abs) %}
                                {% set diff_minutes = (((diff_abs - diff_hours) * 60 * 100)|int + 50) // 100 %}
                                {{ "+" if diff > 0 else "-" }}{{ diff_hours }}時間{{ diff_minutes }}分
                            {% endif %}
                        </td>
                        <td>{{ evaluate_sleep(item.duration) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endif %}
    {% elif period == 'weekly' %}
        <!-- 同様に週別表示 -->
    {% elif period == 'monthly' %}
        <!-- 同様に月別表示 -->
    {% elif period == 'all' %}
        <!-- 全期間表示 -->
    {% endif %}
</div>

<script>
// ドロップダウン変更時の処理
function changePeriod(period) {
    window.location.href = "{{ url_for('average_sleep') }}?period=" + period;
}
</script>

{% endblock %}
